<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>FamilyGo</title>
    <link rel="stylesheet" href="css/upload.css" />
    <!-- jQuery를 import 합니다 -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="javascript/load.js"></script>
    <style>
      .progress {
        width: 27.5%;
        background-color: #e0e0e0;
        border-radius: 13px;
        padding: 3px;
        margin-top: 10px;
      }

      .progress-bar {
        width: 0;
        height: 30px;
        background-color: #76c7c0;
        border-radius: 10px;
        text-align: center;
        line-height: 30px;
        color: white;
        transition: width 0.5s;
      }
    </style>
  </head>
  <body>
    <!-- 이미지 파일 데이터에 알맞는 enctype 설정 -->
    <div class="addImage" id="image-show"><!-- 이미지 띄울 공간 --></div>
    <input type="file" accept="image/*" onchange="loadAndPredict(this)" />
    <div id="label-container"></div>
    <div class="progress">
      <div id="progress-bar" class="progress-bar">0%</div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <script type="text/javascript" src="javascript/script.js" defer></script>
  </body>
</html>

<script>
  function loadAndPredict(input) {
    loadFile(input);
    filePredict(input.files);
  }

  function loadFile(input) {
    let file = input.files[0]; // 선택된 파일 가져오기

    let newImage = document.createElement('img'); //새 이미지 추가

    //이미지 source 가져오기
    newImage.src = URL.createObjectURL(file);
    newImage.id = 'img-id';
    newImage.style.width = '100%';
    newImage.style.height = '100%';
    newImage.style.objectFit = 'cover';

    //이미지를 image-show div에 추가
    let container = document.getElementById('image-show');
    container.appendChild(newImage);
  }

  const modelURL = './my_model/model.json';
  const metadataURL = './my_model/metadata.json';

  let model, labelContainer, maxPredictions;
  let imglist = [];
  let flag = 1;

  async function init() {
    model = await tmImage.load(modelURL, metadataURL);
    maxPredictions = model.getTotalClasses();
    console.log(model);
    labelContainer = document.getElementById('label-container');
    if (flag === 1) {
      for (let i = 0; i < maxPredictions; i++) {
        // and class labels
        labelContainer.appendChild(document.createElement('div'));
      }
      flag = 0;
    }
  }

  async function filePredict(files) {
    await init();
    imglist = [];
    for (let file of files) {
      const img = await createImageBitmap(file);
      imglist.push(img);
    }

    for (let img of imglist) {
      const predictions = await model.predict(img);
      const probability = (predictions[0].probability * 100).toFixed(2);
      updateProgressBar(probability);
      console.log(predictions);
    }
  }

  function updateProgressBar(percentage) {
    const progressBar = document.getElementById('progress-bar');
    progressBar.style.width = percentage + '%';
    progressBar.innerText = percentage + '%';
  }
</script>
